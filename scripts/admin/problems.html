<html>
    <head>
        <title>Next Code 2014 Wingter Olympics</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    </head>
    <body>
        <div class="container">
            <h1>Problems</h1>
            <ul id="problems">
                <li>
                <h2>sum</h2>
                <span id="sum" class="remove">Remove Problem</span>
                <h3>Description:</h3>
                <textarea id="sum-description" class="edit"></textarea>
                <h3>Level:</h3>
                <textarea id="sum-level" class="edit"></textarea>
                <h3>Judge:</h3>
                <ul>
                    <li>
                    <h4>1</h4>
                    <span id="sum-judge-1" class="remove">Remove</span>
                    <p>Input:</p>
                    <textarea id="sum-judge-1-input" class="edit"></textarea>
                    <p>Output:</p>
                    <textarea id="sum-judge-1-output" class="edit"></textarea>
                    </li>
                </ul>
                <span id="sum-judge" class="add-judge">Add</span>
                </li>
            </ul>
            <textarea id="problem-name">problem name</textarea>
            <span id="add-problem">Add Problem</span>
        </div>
    </body>
    <script>
        var firebaseRef = new Firebase('https://wingter-olympics.firebaseIO.com');
        var problemsRef = firebaseRef.child('problems');
        problemsRef.auth('i5QbfhtaYBIKR3bZ68pZwSfXlu4V8X3Tj1xnn3dH');
        function load() {
            problemsRef.once('value', function(problemsSnapshot) {
                var problemsList = '';
                problemsSnapshot.forEach(function(problemSnapshot) {
                    var problem = problemSnapshot.name();
                    problemsList += '<li><h2>' + problem + '</h2>';
                    problemsList += '<span id="' + problem + '" class="remove">Remove Problem</span>';
                    problemsList += '<h3>Description:</h3><textarea id="' + problem + '-description" class="edit">' + problemSnapshot.child('description').val() + '</textarea>';
                    problemsList += '<h3>Level:</h3><textarea id="' + problem + '-level" class="edit">' + problemSnapshot.child('level').val() + '</textarea>';
                    problemsList += '<h3>Judge:</h3><ul>';
                    problemSnapshot.child('judge').forEach(function(judgeSnapshot) {
                        var judge = judgeSnapshot.name();
                        problemsList += '<li><h4>' + judge + '</h4>';
                        problemsList += '<span id="' + problem + '-judge-' + judge + '" class="remove">Remove</span>';
                        problemsList += '<p>Input:</p><textarea id="' + problem + '-judge-' + judge + '-input" class="edit">' + judgeSnapshot.child('input').val() + '</textarea>';
                        problemsList += '<p>Output:</p><textarea id="' + problem + '-judge-' + judge + '-output" class="edit">' + judgeSnapshot.child('output').val() + '</textarea>';
                        problemsList += '</li>';
                    });
                    problemsList += '<span id="' + problem + '-judge" class="add-judge">Add</span></li></ul>';
                });
                $('#problems').html(problemsList);

                // bind the textareas to change functions
                $('.edit').on('change', function(e) {
                    var id = e.target.id;
                    problemsRef.child(id.split('-').join('/')).set($('#' + id).val());
                });

                $('.remove').on('click', function(e) {
                    var id = e.target.id;
                    problemsRef.child(id.split('-').join('/')).remove();
                    load();
                });

                $('.add-judge').on('click', function(e) {
                    var id = e.target.id;
                    var judgeRef = problemsRef.child(id.split('-').join('/'));
                    var judgeSnapshot = problemsSnapshot.child(id.split('-').join('/'));
                    judgeRef.child((judgeSnapshot.numChildren() + 1).toString()).set({
                        'input': 'Problem Input',
                        'output': 'Problem Output'
                    });
                    load();
                });

                $('#add-problem').on('click', function(e) {
                    problemsRef.child($('#problem-name').val()).set({
                        'description': 'Problem Description',
                        'level': 'normal'
                    });
                    load();
                });
            });
        };
        $(document).ready(load());
    </script>
</html>
